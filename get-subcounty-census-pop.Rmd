---
title: "River Cities Population Data"
author: "Kelly Hondula"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(fs)
library(glue)
library(dplyr)
library(tidyr)
library(magrittr)
```

Set location to download data

```{r}
data_dir <- "/nfs/khondula-data/projects/river-cities/data/Census/"
if(!fs::dir_exists(data_dir)){fs::dir_create(data_dir)}
```

# Background and definitions

## Summary levels 

| SUMLEV | description | years |
|--------|-------------|-------|
| 040    | states | 2000-2010, 2010-2018 |
| 050    | counties | 2000-2010, 2010-2018 |
| 061    | minor civil division | 2000-2010, 2010-2018 |
| 071    | minor civil division place part | 2000-2010, 2010-2018 |
| 157    | county place part | 2000-2010, 2010-2018 |
| 162    | incorporated place | 2000-2010, 2010-2018 |
| 170    | Consolidated city | 2010-2018 |
| 172    | Consolidated city -- place within consolidated city | 2010-2018 |
| 310    | Metropolitan/Micropolitan Statistical Area | 2010-2018 |
| 314    | Metropolitan Division | 2010-2018? |
| 330    | Combined statistical area | 2010-2018? |

## Categorical variable definitions

Another useful reference is the [Population estimates categorical variables](https://www.census.gov/data/developers/data-sets/popest-popproj/popest/popest-vars/2018.html)

## Glossary

* [definition of statistical areas](https://www.census.gov/topics/housing/housing-patterns/about/core-based-statistical-areas.html)
* [glossary document](https://www2.census.gov/programs-surveys/demo/about/housing-patterns/glossary2.pdf)

## lists of FIPS codes

* https://www2.census.gov/programs-surveys/cps/methodology/Geographic%20Coding%20-%20Metro%20Areas%20(since%20August%202005).pdf

## CBSA to FIPS Crosswalk

From the NBER site: https://data.nber.org/data/cbsa-fips-county-crosswalk.html

```{r, include = FALSE}
xwalk_filepath <- "https://data.nber.org/cbsa-csa-fips-county-crosswalk/cbsa2fipsxw.csv"
xwalk_file_local <- glue::glue("{data_dir}/{basename(xwalk_filepath)}")
download.file(xwalk_filepath, destfile = xwalk_file_local)
```


# City and Town Level

## Intercensal 2000 - 2010

* [File layout](https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2000-2010/intercensal/cities/sub-est00int.pdf)
* [methodology](https://www2.census.gov/programs-surveys/popest/technical-documentation/methodology/intercensal/2000-2010-intercensal-estimates-methodology.pdf)

### Download data

```{r}
citytown_filepath <- "https://www2.census.gov/programs-surveys/popest/datasets/2000-2010/intercensal/cities/sub-est00int.csv"
citytown_file_local <- glue::glue("{data_dir}/{basename(citytown_filepath)}")
download.file(citytown_filepath, destfile = citytown_file_local)
```

### Read in and reshape

```{r}
citytown_df <- readr::read_csv(citytown_file_local)

citytown_long <- citytown_df %>%
  # filter out state and county level values
  filter(SUMLEV %in% c("061", "071", "157", "162")) %>%
  # keep grouping levels
  group_by(SUMLEV, STATE, COUNTY, PLACE, COUSUB, NAME, STNAME) %>%
  # convert columns to rows
  tidyr::pivot_longer(cols = ESTIMATESBASE2000:POPESTIMATE2010, 
                      names_to = "estimate", values_to = "population") %>%
  # separate year and estimate type into separate columns 
  # extract years as a the numbers in the estimate column
  mutate(year = stringr::str_extract(estimate, "\\d+")) %>%
  mutate(year = as.numeric(year)) %>%
  # extract letters
  mutate(estimate_type = stringr::str_extract(estimate, "[A-Z]+")) %>%
  dplyr::select(-estimate)
```

### Save

```{r}
citytown_long %>% 
  readr::write_csv(glue("{data_dir}/Subcounty_Intercensal_Pop_2000-2010.csv"))
```

## Intercensal 2010 - 2018

* [methodology](https://www.census.gov/data/tables/time-series/demo/popest/2010s-total-cities-and-towns.html)
* [file-layout](https://www2.census.gov/programs-surveys/popest/technical-documentation/file-layouts/2010-2018/sub-est2018.pdf)

### Download data

```{r}
citytown_filepath2 <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2018/cities/totals/sub-est2018_all.csv"
citytown_file2_local <- glue::glue("{data_dir}/{basename(citytown_filepath2)}")
download.file(citytown_filepath2, destfile = citytown_file2_local)
```

### Read in and reshape

```{r}
citytown2_df <- readr::read_csv(citytown_file2_local, col_types = "ccccccccccddddddddddd")
```

```{r}
citytown2_long <- citytown2_df %>% 
  filter(SUMLEV %in% c("061", "071", "157", "162", "170", "172")) %>%
  dplyr::select(-PRIMGEO_FLAG, -FUNCSTAT) %>% # dont think these are necessary
  group_by(SUMLEV, STATE, COUNTY, PLACE, COUSUB, CONCIT, NAME, STNAME) %>%
  tidyr::pivot_longer(cols = CENSUS2010POP:POPESTIMATE2018, 
                      names_to = "estimate", values_to = "population") %>%
   mutate(year = stringr::str_extract(estimate, "\\d+")) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(estimate_type = stringr::str_extract(estimate, "[A-Z]+")) %>%
  dplyr::select(-estimate)
```

```{r}
citytown2_long %>% 
  readr::write_csv(glue("{data_dir}/Subcounty_Intercensal_Pop_2010-2018.csv"))
```

* Data for 1990 to 2000 is in tables [here](https://www.census.gov/data/tables/time-series/demo/popest/2000-subcounties-eval-estimates.html)

# Metro and Micro Statistical Areas Level

### Download

```{r}
msa_file <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2018/metro/totals/cbsa-est2018-alldata.csv"
msa_file_local <- glue::glue("{data_dir}/{basename(msa_file)}")
download.file(msa_file, destfile = msa_file_local)
```

### Read in and reshape


```{r}
msa_df <- readr::read_csv(msa_file_local) %>%
  dplyr::select(1:16)
msa_long <- msa_df %>% 
  group_by(CBSA, MDIV, STCOU, NAME, LSAD) %>%
  tidyr::pivot_longer(cols = CENSUS2010POP:POPESTIMATE2018, 
                      names_to = "estimate", values_to = "population") %>%
  mutate(year = stringr::str_extract(estimate, "\\d+")) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(estimate_type = stringr::str_extract(estimate, "[A-Z]+")) %>%
  dplyr::select(-estimate)
```

Add in state info from crosswalk

```{r}
cbsa2fips <- readr::read_csv(xwalk_file_local)
cbsa2fips_state <- cbsa2fips %>% 
  dplyr::select(cbsacode, statename, fipsstatecode) %>%
  dplyr::distinct()
```

| CBSA | Core based statistical area code |
| MDIV | Metropolitan division code |
| STCOU | State and county code |
| NAME | Name/title of area |
| LSAD | Legal/staticial area description |

```{r}
msa_long_wState <- msa_long %>% 
  left_join(cbsa2fips_state, by = c("CBSA" = "cbsacode")) %>%
  dplyr::rename(STNAME = statename, STATE = fipsstatecode)

msa_long_wState %>% 
  readr::write_csv(glue("{data_dir}/msa_long_wState.csv"))
```

# Combined statistical Areas

```{r}
csa_file <- "https://www2.census.gov/programs-surveys/popest/datasets/2010-2018/metro/totals/csa-est2018-alldata.csv"
csa_file_local <- glue::glue("{data_dir}/{basename(csa_file)}")
download.file(csa_file, destfile = csa_file_local)
```

```{r}
csa_df <- readr::read_csv(csa_file_local) %>% 
  dplyr::select(1:17)

# filter and convert from wide to long
csa_long <- csa_df %>% 
  group_by(CSA, CBSA, MDIV, STCOU, NAME, LSAD) %>%
  tidyr::pivot_longer(cols = CENSUS2010POP:POPESTIMATE2018, 
                      names_to = "estimate", values_to = "population") %>%
  mutate(year = stringr::str_extract(estimate, "\\d+")) %>%
  mutate(year = as.numeric(year)) %>%
  mutate(estimate_type = stringr::str_extract(estimate, "[A-Z]+")) %>%
  dplyr::select(-estimate)
```

Add in state info from crosswalk

```{r}
csa2fips_state <- cbsa2fips %>% 
  dplyr::select(csacode, statename, fipsstatecode) %>%
  dplyr::distinct()
```

```{r}
csa_long_wState <- csa_long %>% 
  left_join(csa2fips_state, by = c("CSA" = "csacode")) %>%
  dplyr::rename(STNAME = statename, STATE = fipsstatecode)
```

```{r}
csa_long_wState %>%
    readr::write_csv(glue("{data_dir}/csa_long_wState.csv"))
```

# Combined dataset

Need to add in columns to some tables combine everything together 

* Subcounty 2000-2010
* Subcounty 2010-2018
* Micro and Metro 2010-2018
* Combined Stat areas 2010-2018

```{r}
subcounty_20002018 <- citytown_long %>% 
  ungroup() %>%
  mutate(CONCIT = NA, SUMLEV = as.character(SUMLEV)) %>%
  dplyr::bind_rows(citytown2_long) %>%
  dplyr::select(-COUNTY, -PLACE, -COUSUB, -CONCIT)

msa_csa <- msa_long_wState %>% 
  ungroup() %>%
  mutate(CSA = NA) %>%
  dplyr::bind_rows(csa_long_wState) %>%
  dplyr::rename(SUMLEV = LSAD) %>%
  dplyr::select(-STCOU)

subcounty_20002018 %<>% mutate(CBSA = NA, MDIV = NA, CSA = NA)

censuspop_all <- dplyr::bind_rows(subcounty_20002018, msa_csa)
```

```{r, echo=FALSE, as.is = TRUE}
kableExtra::kable(head(censuspop_all, 20))
```

Save output

```{r, eval=FALSE}
output_dir <- "/nfs/public-data/Census"
readr::write_csv(censuspop_all, file.path(output_dir, "Census_FineScalePop_2000-2018.csv"))
```

Explore using [shiny gadget](https://github.com/khondula/river-cities/blob/master/SubCounty_gadget.R)

Fin
