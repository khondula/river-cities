---
title: "Claims data places"
author: "Kelly Hondula"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

National Flood Insurance Program Claims data

[Source](https://www.fema.gov/media-library/assets/documents/180374)

```{r}
library(fs)
library(sf)
library(glue)
library(dplyr)
library(tidyr)
library(ggplot2)
library(magrittr)
library(leaflet)
library(rslurm)
library(dataRetrieval)
```

Download data

```{r}
claims_url <- 'https://www.fema.gov/media-library-data/1575491579309-2366ee38d902c1bc983370e132ee36cc/FIMA_NFIP_Redacted_Claims_Data_Set.zip'
data_dir <- "/nfs/khondula-data/projects/river-cities/data/"
claims_file_local <- glue::glue("{data_dir}/{basename(claims_url)}")
```

```{r, eval = FALSE}
if(!fs::dir_exists(data_dir)){fs::dir_create(data_dir)}
download.file(claims_url, destfile = claims_file_local)
unzip(claims_file_local, exdir = data_dir)
```

```{r}
claims_data_file <- glue::glue("{data_dir}/NFIP/openFEMA_claims20190831.csv")
claims_df <- vroom::vroom(claims_data_file)
```


```{r}
claims_census_tracts <- claims_df$censustract %>% unique()
tracts_nchar <- purrr::map_int(claims_census_tracts, ~nchar(.x))
claims_tracts11 <- claims_census_tracts[which(tracts_nchar == 11)]
rm(claims_df, claims_census_tracts, tracts_nchar)
tibble::tibble(tract = claims_tracts11) %>%
  readr::write_csv(glue::glue("{data_dir}/claims_tracts11.csv"))
```

Spatial columns in claims data

* reported city
* countyCode
* censusTract
* latitude (1 decimal)
* longitude (1 decimal)
* state
* reportedZipCode

> US Census Bureau defined census Tracts; statistical subdivisions of a county or equivalent entity that are updated prior to each decennial census. The NFIP relies on our geocoding service to assign census tract code. 11 digit code defining census tract

```{r}
is.na(claims_df$censustract) %>% table() # 59,300 missing (2.4%)
is.na(claims_df$reportedcity) %>% table() # 4505 missing
is.na(claims_df$state) %>% table() # 12 missing
is.na(claims_df$reportedzipcode) %>% table() # 1131 missing

length(unique(claims_df$censustract)) # 54,858 census tracts
# 74,134 tracts total in US
```



